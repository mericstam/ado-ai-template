# Implement Stage Template
# Creates feature branch, implements solution, creates PR
#
# Supports both standalone and submodule modes:
# - Standalone: scripts in ./scripts/, systems in ./systems/
# - Submodule: scripts in ./template/scripts/, systems in ./systems/ + ./template/systems/

parameters:
  - name: workItemId
    type: string
  - name: targetRepo
    type: string
  - name: dodConfig
    type: string
    default: 'default'

jobs:
  - job: ImplementSolution
    displayName: 'Implement Solution'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self
        displayName: 'Checkout repository'
        persistCredentials: true
        submodules: true

      - script: |
          # Detect submodule mode
          if [ -d "template/scripts" ]; then
            SCRIPTS="template/scripts"
            SUBMODULE_MODE="true"
            echo "Running in submodule mode"
          else
            SCRIPTS="scripts"
            SUBMODULE_MODE="false"
            echo "Running in standalone mode"
          fi
          chmod +x $SCRIPTS/*.sh scripts/*.sh 2>/dev/null || true
          echo "##vso[task.setvariable variable=SCRIPTS_DIR]$SCRIPTS"
          echo "##vso[task.setvariable variable=SUBMODULE_MODE]$SUBMODULE_MODE"
        displayName: 'Detect environment'

      # ai-working tag already added in Process stage

      - script: |
          # Configure git
          git config user.name "AI Agent"
          git config user.email "ai-agent@pipeline.local"

          # Create feature branch
          BRANCH_NAME="ai/${{ parameters.workItemId }}"
          git checkout -b "$BRANCH_NAME"
          echo "##vso[task.setvariable variable=BRANCH_NAME]$BRANCH_NAME"
        displayName: 'Create feature branch'

      - script: |
          SCRIPTS="$(SCRIPTS_DIR)"
          # Fetch work item context and download attachments
          mkdir -p attachments
          ./$SCRIPTS/get-workitem-context.sh \
            --work-item-id "${{ parameters.workItemId }}" \
            --output "workitem-context.json" \
            --attachments-dir "attachments"

          # List downloaded attachments
          echo "Attachments downloaded:"
          ls -la attachments/ 2>/dev/null || echo "  (none)"
        displayName: 'Fetch work item context and attachments'
        env:
          AZURE_DEVOPS_ORG: $(AZURE_DEVOPS_ORG)
          AZURE_DEVOPS_PROJECT: $(System.TeamProject)
          AZURE_DEVOPS_PAT: $(System.AccessToken)

      - script: |
          SCRIPTS="$(SCRIPTS_DIR)"
          SUBMODULE_MODE="$(SUBMODULE_MODE)"

          # Build systems-dir arguments based on mode
          if [ "$SUBMODULE_MODE" = "true" ]; then
            SYSTEM=$(./$SCRIPTS/resolve-system-config.sh \
              --context-file workitem-context.json \
              --systems-dir systems \
              --systems-dir template/systems)
          else
            SYSTEM=$(./$SCRIPTS/resolve-system-config.sh \
              --context-file workitem-context.json)
          fi
          echo "Detected system: $SYSTEM"
          echo "##vso[task.setvariable variable=DETECTED_SYSTEM]$SYSTEM"

          # Copy OpenCode config to workspace root
          # Priority: local systems > template systems
          if [ -f "systems/_default/opencode.json" ]; then
            cp systems/_default/opencode.json ./opencode.json
            echo "Using local opencode.json"
          elif [ -f "template/systems/_default/opencode.json" ]; then
            cp template/systems/_default/opencode.json ./opencode.json
            echo "Using template opencode.json"
          fi

          # Load skills in layers
          rm -rf .opencode/skills
          mkdir -p .opencode/skills

          if [ "$SUBMODULE_MODE" = "true" ]; then
            # 1. Template default skills (generic base)
            if [ -d "template/systems/_default/skills" ]; then
              echo "Loading template default skills..."
              cp -r template/systems/_default/skills/* .opencode/skills/ 2>/dev/null || true
            fi

            # 2. Local default skills (organization-specific, can override template)
            if [ -d "systems/_default/skills" ]; then
              echo "Loading organization-specific skills..."
              cp -r systems/_default/skills/* .opencode/skills/ 2>/dev/null || true
            fi

            # 3. System-specific skills from both locations
            for systems_dir in template/systems systems; do
              if [ -d "$systems_dir/$SYSTEM/skills" ] && [ "$(ls -A $systems_dir/$SYSTEM/skills 2>/dev/null)" ]; then
                echo "Loading skills from $systems_dir/$SYSTEM..."
                cp -r $systems_dir/$SYSTEM/skills/* .opencode/skills/ 2>/dev/null || true
              fi
            done
          else
            # Standalone mode: simple loading
            if [ -d "systems/_default/skills" ]; then
              echo "Loading default skills..."
              cp -r systems/_default/skills/* .opencode/skills/ 2>/dev/null || true
            fi
            if [ -d "systems/$SYSTEM/skills" ] && [ "$(ls -A systems/$SYSTEM/skills 2>/dev/null)" ]; then
              echo "Loading skills from system: $SYSTEM"
              cp -r systems/$SYSTEM/skills/* .opencode/skills/ 2>/dev/null || true
            fi
          fi

          echo "Loaded skills:"
          ls .opencode/skills/ 2>/dev/null || echo "  (none)"
        displayName: 'Resolve system configuration'

      - script: |
          SCRIPTS="$(SCRIPTS_DIR)"
          SUBMODULE_MODE="$(SUBMODULE_MODE)"
          SYSTEM="$(DETECTED_SYSTEM)"

          # Build prompt with appropriate systems-dir arguments
          if [ "$SUBMODULE_MODE" = "true" ]; then
            PROMPT=$(./$SCRIPTS/build-prompt.sh \
              --mode implement \
              --system "$SYSTEM" \
              --context workitem-context.json \
              --systems-dir systems \
              --systems-dir template/systems)
          else
            PROMPT=$(./$SCRIPTS/build-prompt.sh \
              --mode implement \
              --system "$SYSTEM" \
              --context workitem-context.json)
          fi

          # Log what we're sending to OpenCode
          echo "=============================================="
          echo "OPENCODE INPUT - IMPLEMENT MODE"
          echo "=============================================="
          echo "System: $SYSTEM"
          echo "Submodule Mode: $SUBMODULE_MODE"
          echo ""
          echo "--- PROMPT ---"
          echo "$PROMPT"
          echo ""
          echo "--- OPENCODE CONFIG ---"
          cat ./opencode.json
          echo ""
          echo "=============================================="

          # Create OpenCode auth directory and inject auth.json
          mkdir -p $HOME/.local/share/opencode
          echo "$OPENCODE_AUTH_JSON" > $HOME/.local/share/opencode/auth.json

          docker run --rm \
            -e ADO_MCP_AUTH_TOKEN \
            -e AZURE_DEVOPS_ORG_URL="https://dev.azure.com/$AZURE_DEVOPS_ORG" \
            -v "$HOME/.local/share/opencode:/root/.local/share/opencode" \
            -v "$(pwd):/workspace" \
            -w /workspace \
            jspannareif/opencode-mcp run "$PROMPT"
        displayName: 'Run OpenCode Implementation'
        env:
          OPENCODE_AUTH_JSON: $(OPENCODE_AUTH_JSON)
          ADO_MCP_AUTH_TOKEN: $(System.AccessToken)
          AZURE_DEVOPS_ORG: $(AZURE_DEVOPS_ORG)

      - script: |
          SUBMODULE_MODE="$(SUBMODULE_MODE)"
          SYSTEM="$(DETECTED_SYSTEM)"

          # Find config file (local takes priority)
          if [ "$SUBMODULE_MODE" = "true" ]; then
            if [ -f "systems/$SYSTEM/config.yml" ]; then
              CONFIG_FILE="systems/$SYSTEM/config.yml"
            elif [ -f "template/systems/$SYSTEM/config.yml" ]; then
              CONFIG_FILE="template/systems/$SYSTEM/config.yml"
            elif [ -f "systems/_default/config.yml" ]; then
              CONFIG_FILE="systems/_default/config.yml"
            else
              CONFIG_FILE="template/systems/_default/config.yml"
            fi
          else
            CONFIG_FILE="systems/$SYSTEM/config.yml"
            if [ ! -f "$CONFIG_FILE" ]; then
              CONFIG_FILE="systems/_default/config.yml"
            fi
          fi

          echo "Running quality gates from: $CONFIG_FILE"

          # Extract and run build command
          BUILD_CMD=$(grep -A1 "build:" "$CONFIG_FILE" | grep "command:" | cut -d'"' -f2)
          if [ -n "$BUILD_CMD" ]; then
            echo "Running build: $BUILD_CMD"
            eval "$BUILD_CMD" || exit 1
          fi

          # Extract and run test command
          TEST_CMD=$(grep -A1 "test:" "$CONFIG_FILE" | grep "command:" | cut -d'"' -f2)
          if [ -n "$TEST_CMD" ]; then
            echo "Running tests: $TEST_CMD"
            eval "$TEST_CMD" || exit 1
          fi

          # Extract and run lint command
          LINT_CMD=$(grep -A1 "lint:" "$CONFIG_FILE" | grep "command:" | cut -d'"' -f2)
          if [ -n "$LINT_CMD" ]; then
            echo "Running lint: $LINT_CMD"
            eval "$LINT_CMD" || exit 1
          fi

          echo "All quality gates passed!"
        displayName: 'Run Definition of Done checks'
        continueOnError: false

      - script: |
          # Commit and push changes
          git add -A
          git commit -m "AI Agent: Implement work item #${{ parameters.workItemId }}

          Automated implementation by AI Agent pipeline.
          Work Item: ${{ parameters.workItemId }}"

          # Push to remote
          git push --set-upstream origin "$(BRANCH_NAME)"
        displayName: 'Commit and push changes'
        env:
          GH_HOST: $(GH_HOST)
          GH_TOKEN: $(GHE_TOKEN)

      - script: |
          # Create Pull Request using GitHub CLI
          gh pr create \
            --title "AI Agent: Work Item #${{ parameters.workItemId }}" \
            --body "## Automated PR

          This PR was created by the AI Agent pipeline.

          **Work Item:** #${{ parameters.workItemId }}
          **Pipeline:** [Build $(Build.BuildId)]($(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId))

          Please review the changes and merge when ready." \
            --base main \
            --head "$(BRANCH_NAME)" > pr-url.txt

          PR_URL=$(cat pr-url.txt)
          echo "##vso[task.setvariable variable=PR_URL]$PR_URL"
          echo "Created PR: $PR_URL"
        displayName: 'Create Pull Request'
        env:
          GH_HOST: $(GH_HOST)
          GH_TOKEN: $(GHE_TOKEN)

      - script: |
          SCRIPTS="$(SCRIPTS_DIR)"
          # Update work item with PR link
          PR_URL=$(cat pr-url.txt)

          ./$SCRIPTS/update-workitem.sh \
            --work-item-id "${{ parameters.workItemId }}" \
            --add-comment "## Implementation Complete

          Pull Request created: $PR_URL

          Please review and merge when ready." \
            --remove-tag "ai-working" \
            --remove-tag "ai-approved"
        displayName: 'Update work item with PR link'
        env:
          AZURE_DEVOPS_ORG: $(AZURE_DEVOPS_ORG)
          AZURE_DEVOPS_PROJECT: $(System.TeamProject)
          AZURE_DEVOPS_PAT: $(System.AccessToken)

      - script: |
          SCRIPTS="$(SCRIPTS_DIR)"
          # Notify on failure
          ./$SCRIPTS/send-teams-notification.sh \
            --type "error" \
            --work-item-id "${{ parameters.workItemId }}" \
            --message "Implementation stage failed" \
            --pipeline-url "$(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"

          ./$SCRIPTS/update-workitem.sh \
            --work-item-id "${{ parameters.workItemId }}" \
            --add-tag "ai-failed" \
            --remove-tag "ai-working" \
            --add-comment "## Implementation Failed

          The AI Agent encountered an error during implementation.
          Please check the [pipeline logs]($(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)) for details."
        displayName: 'Handle failure'
        condition: failed()
        env:
          AZURE_DEVOPS_ORG: $(AZURE_DEVOPS_ORG)
          AZURE_DEVOPS_PROJECT: $(System.TeamProject)
          AZURE_DEVOPS_PAT: $(System.AccessToken)
          TEAMS_WEBHOOK_URL: $(TEAMS_WEBHOOK_URL)
